@page "/torrents"
@implements IDisposable
@inject TorrentServiceClient Client
@inject IUriHelper UriHelper

@if (Model == null)
{
    <div class="h-100 d-flex justify-content-center align-items-center">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
}
else
{
    <Filtration Model="@FilterModel" ChangedHandler="@FiltrationhButtonClick" />

    <TorrentTable Items="@Model.TorrentItems" ClickHandler="@TorrentDetailsClick" Context="torrent">
        <TableHeader>
            <th scope="col" style="width:10%">@nameof(TorrentItemViewModel.Id)</th>
            <th scope="col" style="width:15%">@nameof(TorrentItemViewModel.Size)</th>
            <th scope="col" style="width:10%">@nameof(TorrentItemViewModel.Date)</th>
            <th scope="col">@nameof(TorrentItemViewModel.Title)</th>
        </TableHeader>
        <RowTemplate>
            <th scope="row">
                <a href="/torrent/@torrent.Id" class="text-body">@torrent.Id</a>
            </th>
            <td>@torrent.Size</td>
            <td>@torrent.Date.ToShortDateString()</td>
            <td><a href="/torrent/@torrent.Id" class="text-body">@torrent.Title</a></td>
        </RowTemplate>
        <TableFooter>

        </TableFooter>
    </TorrentTable>

    <Pagination Model="@Model.PaginationModel" PageChanged="@PageButtonClick" />
}

@functions
{
    private TorrentsViewModel Model { get; set; }
    private FiltrationViewModel FilterModel { get; set; }
    private int Page { get; set; }
    private const string quearyTemplate = "/torrents?search={0}&page={1}";

    protected override async Task OnInitAsync()
    {
        FilterModel = new FiltrationViewModel();

        await RefreshType();
        UriHelper.OnLocationChanged += OnLocationChanges;
    }

    private void OnLocationChanges(object sender, string location) => RefreshType().GetAwaiter();

    private async Task RefreshType()
    {
        var uri = new Uri(UriHelper.GetAbsoluteUri());

        FilterModel.Search = QueryHelpers.ParseQuery(uri.Query).TryGetValue("search", out var searchParam)
            ? searchParam.FirstOrDefault()
            : null;

        Page = QueryHelpers.ParseQuery(uri.Query).TryGetValue("page", out var pageParam)
               && int.TryParse(pageParam.FirstOrDefault(), out var pageParamId)
               && pageParamId > 1
               ? pageParamId
               : 1;

        await LoadTorrentsAsync();
        StateHasChanged();
    }

    private async Task LoadTorrentsAsync() => Model = await Client.GetTorrentsAsync(Page, Constants.DefaultPageSize, FilterModel);

    private void TorrentDetailsClick(long id) => UriHelper.NavigateTo($"/torrent/{id}");

    private void PageButtonClick(int page)
    {
        var uri = string.Format(quearyTemplate, FilterModel.Search, page);

        UriHelper.NavigateTo(uri);
    }

    private void FiltrationhButtonClick()
    {
        var uri = string.Format(quearyTemplate, FilterModel.Search, 1);

        UriHelper.NavigateTo(uri);
    }

    public void Dispose() => UriHelper.OnLocationChanged -= OnLocationChanges;
}