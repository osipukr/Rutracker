@inject IMatToaster MatToaster
@inject AppStateService AppState
@inject ViewSettings ViewSettings

<div class="mat-layout-grid px-0">
    <div class="mat-layout-grid-inner">
        <div class="mat-layout-grid-cell mat-layout-grid-cell-span-12">
            <EditForm Model="@Model" OnValidSubmit="@OnValidSubmitClicked">
                <DataAnnotationsValidator />

                <MatTextField Type="search"
                              @bind-Value="@Model.Search"
                              @bind-Value:event="oninput"
                              FullWidth="true"
                              IconTrailing="true"
                              Icon="@MatIconNames.Search"
                              InputStyle="padding: 20px 48px 6px 16px;"
                              Label="Search" />

                <ValidationMessage For="@(() => Model.Search)" />

                <MatAccordion Multi="true" Class="my-4">
                    <MatExpansionPanel>
                        <MatExpansionPanelSummary Class="no-select">
                            <MatExpansionPanelHeader>Size range</MatExpansionPanelHeader>
                        </MatExpansionPanelSummary>

                        <MatExpansionPanelDetails>
                            <div class="d-flex flex-wrap">
                                <div class="flex-fill mx-2">
                                    <MatNumeric Label="From" @bind-Value="@Model.SizeFrom" />
                                    <ValidationMessage For="@(() => Model.SizeFrom)" />
                                </div>

                                <div class="flex-fill mx-2">
                                    <MatNumeric Label="To" @bind-Value="@Model.SizeTo" />
                                    <ValidationMessage For="@(() => Model.SizeTo)" />
                                </div>
                            </div>
                        </MatExpansionPanelDetails>
                    </MatExpansionPanel>

                    <MatExpansionPanel>
                        <MatExpansionPanelSummary Class="no-select">
                            <MatExpansionPanelHeader>Forum titles category</MatExpansionPanelHeader>
                        </MatExpansionPanelSummary>

                        <MatExpansionPanelDetails>
                            @if (TitleFacet != null && TitleFacet.FacetItems != null)
                            {
                                foreach (var facet in TitleFacet.FacetItems)
                                {
                                    <MatCheckbox @bind-Checked="@facet.IsSelected">
                                        @facet.Value

                                        <span class="badge badge-pill text-white" style="background-color: var(--mdc-theme-primary, #6200ee);">
                                            @facet.Count
                                        </span>
                                    </MatCheckbox>
                                }
                            }
                        </MatExpansionPanelDetails>
                    </MatExpansionPanel>
                </MatAccordion>

                <div class="d-flex justify-content-end">
                    <div class="d-flex justify-content-between filter-group-btn">
                        <MatButton OnClick="@ResetButtonClicked"
                                   Type="reset"
                                   Disabled="@AppState.SearchInProgress"
                                   Outlined="true"
                                   Class="filter-btn"
                                   Label="All" />

                        <MatButton Type="submit"
                                   Disabled="@AppState.SearchInProgress"
                                   Raised="true"
                                   Class="filter-btn"
                                   Label="Apply" />
                    </div>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code
{
    [Parameter] FiltrationViewModel Model { get; set; }
    [Parameter] EventCallback FilterChanged { get; set; }

    int TitleCount => ViewSettings.ForumTitlesCount;
    FacetViewModel<string> TitleFacet { get; set; }

    protected override async Task OnInitAsync() => await LoadTitleFacetsAsync();

    async Task LoadTitleFacetsAsync()
    {
        try
        {
            TitleFacet = await AppState.GetTitleFacetAsync(TitleCount);
        }
        catch (Exception ex)
        {
            MatToaster.Add(ex.Message, MatToastType.Warning, "Titles Load Failed", MatIconNames.Warning);
        }
    }

    void ResetFiltration()
    {
        Model.Search = null;
        Model.SizeFrom = null;
        Model.SizeTo = null;
        Model.SelectedTitleIds = null;

        if (TitleFacet != null && TitleFacet.FacetItems != null)
        {
            foreach (var facet in TitleFacet.FacetItems)
            {
                facet.IsSelected = false;
            }
        }
    }

    void ResetButtonClicked()
    {
        ResetFiltration();
        OnValidSubmitClicked();
    }

    void OnValidSubmitClicked()
    {
        Model.SelectedTitleIds = TitleFacet?.FacetItems?.Where(x => x.IsSelected).Select(x => x.Id);
        FilterChanged.InvokeAsync(EventArgs.Empty);
    }
}