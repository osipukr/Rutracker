@inject IMatToaster MatToaster
@inject AppStateService AppState
@inject ViewSettings ViewSettings

<div class="mat-layout-grid px-0">
    <div class="mat-layout-grid-inner">
        <div class="mat-layout-grid-cell mat-layout-grid-cell-span-12">
            <EditForm Model="@Model" OnValidSubmit="@OnValidSubmitClicked">
                <DataAnnotationsValidator />

                <div class="mat-layout-grid-inner pt-0 pb-3">
                    <div class="mat-layout-grid-cell mat-layout-grid-cell-span-12">
                        <MatTextField @bind-Value="@Model.Search"
                                      Label="Search"
                                      Icon="@MatIconNames.Search"
                                      IconTrailing="true"
                                      FullWidth="true">
                        </MatTextField>
                    </div>

                    <div class="mat-layout-grid-cell mat-layout-grid-cell-span-12">
                        <ValidationMessage For="@(() => Model.Search)" />
                    </div>
                </div>

                <MatAccordion Multi="true">
                    <MatExpansionPanel>
                        <MatExpansionPanelSummary Class="no-select">
                            <MatExpansionPanelHeader>Size range</MatExpansionPanelHeader>
                        </MatExpansionPanelSummary>
                        <MatExpansionPanelDetails>
                            <div class="mat-layout-grid-inner py-0">
                                <div class="mat-layout-grid-cell mat-layout-grid-cell-span-6">
                                    <MatNumeric Label="From" @bind-Value="@Model.SizeFrom" />
                                </div>

                                <div class="mat-layout-grid-cell mat-layout-grid-cell-span-6">
                                    <MatNumeric Label="To" @bind-Value="@Model.SizeTo" />
                                </div>

                                <div class="mat-layout-grid-cell mat-layout-grid-cell-span-6">
                                    <ValidationMessage For="@(() => Model.SizeFrom)" />
                                </div>

                                <div class="mat-layout-grid-cell mat-layout-grid-cell-span-6">
                                    <ValidationMessage For="@(() => Model.SizeTo)" />
                                </div>
                            </div>
                        </MatExpansionPanelDetails>
                    </MatExpansionPanel>

                    <MatExpansionPanel>
                        <MatExpansionPanelSummary Class="no-select">
                            <MatExpansionPanelHeader>Forum titles category</MatExpansionPanelHeader>
                        </MatExpansionPanelSummary>
                        <MatExpansionPanelDetails>
                            @if (TitleFacet != null && TitleFacet.FacetItems != null)
                            {
                                <div class="mat-layout-grid-inner p-0 pt-3">
                                    @foreach (var facet in TitleFacet.FacetItems)
                                    {
                                        <div class="mat-layout-grid-cell mat-layout-grid-cell-span-12">
                                            <MatCheckbox @bind-Checked="@facet.IsSelected">
                                                <span>@facet.Value - (Count: @facet.Count)</span>
                                            </MatCheckbox>
                                        </div>
                                    }
                                </div>
                            }
                        </MatExpansionPanelDetails>
                    </MatExpansionPanel>
                </MatAccordion>

                <div class="mat-layout-grid mat-layout-grid-align-right px-0 pb-0 pt-3">
                    <div class="mat-layout-grid-inner">
                        <div class="mat-layout-grid-cell mat-layout-grid-cell-span-12" style="grid-column-end: none">
                            <MatButton Disabled="@AppState.SearchInProgress"
                                       OnClick="@ResetButtonClicked"
                                       Outlined="true"
                                       Type="reset"
                                       Class="filter-btn">
                                All
                            </MatButton>

                            <MatButton Disabled="@AppState.SearchInProgress"
                                       OnClick="@OnSubmitClicked"
                                       Raised="true"
                                       Class="filter-btn">
                                Apply
                            </MatButton>
                        </div>
                    </div>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code
{
    [Parameter] FiltrationViewModel Model { get; set; }
    [Parameter] EventCallback<FiltrationViewModel> FilterChanged { get; set; }

    int TitleCount => ViewSettings.ForumTitlesCount;
    FacetViewModel<string> TitleFacet { get; set; }

    protected override async Task OnInitAsync() => await LoadTitleFacetsAsync();

    async Task LoadTitleFacetsAsync()
    {
        try
        {
            TitleFacet = await AppState.GetTitlesAsync(TitleCount);
        }
        catch (Exception ex)
        {
            MatToaster.Add(ex.Message, MatToastType.Warning, "Titles Load Failed", MatIconNames.Warning);
        }
    }

    void ResetFiltration()
    {
        Model.Search = null;
        Model.SizeFrom = null;
        Model.SizeTo = null;
        Model.SelectedTitleIds = null;

        if (TitleFacet != null && TitleFacet.FacetItems != null)
        {
            foreach (var facet in TitleFacet.FacetItems)
            {
                facet.IsSelected = false;
            }
        }
    }

    void OnSubmitClicked() => Model.SelectedTitleIds = TitleFacet?.FacetItems?.Where(x => x.IsSelected).Select(x => x.Id);

    void ResetButtonClicked()
    {
        ResetFiltration();
        OnValidSubmitClicked();
    }

    void OnValidSubmitClicked() => FilterChanged.InvokeAsync(Model);
}