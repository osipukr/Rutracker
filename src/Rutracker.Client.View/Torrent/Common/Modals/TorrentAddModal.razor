@inject ITorrentService TorrentService
@inject ISubcategoryService SubcategoryService
@inject IMatToaster MatToaster

<EditForm Model="@_torrentCreate" OnValidSubmit="@CreateClicked" autocomplete="off">
    <DataAnnotationsValidator />

    <FormControl Class="Form-Cotrol">
        <MatSelect @bind-Value="@_torrentCreate.SubcategoryId"
                   TValue="int"
                   Label="Subcategory"
                   Enhanced="true"
                   ValidationDisabled="true"
                   Class="w-100">
            @if (_subcategories != null)
            {
                @foreach (var subcategory in _subcategories)
                {
                    <MatOption TValue="int" Value="@subcategory.Id">@subcategory.Name</MatOption>
                }
            }
        </MatSelect>
    </FormControl>

    <FormControl Class="Form-Cotrol">
        <MatTextField @bind-Value="@_torrentCreate.Name"
                      Label="Name"
                      Icon="@MatIconNames.Title"
                      IconTrailing="true"
                      FullWidth="true"
                      Required="true" />

        <ValidationMessage For="@(() => _torrentCreate.Name)" />
    </FormControl>

    <FormControl Class="Form-Cotrol">
        <MatTextField @bind-Value="@_torrentCreate.Description"
                      Label="Description"
                      Icon="@MatIconNames.Description"
                      IconTrailing="true"
                      FullWidth="true"
                      Required="true" />

        <ValidationMessage For="@(() => _torrentCreate.Description)" />
    </FormControl>

    <FormControl Class="Form-Cotrol mt-3">
        <MatTextField @bind-Value="@_torrentCreate.Content"
                      Label="Content"
                      FullWidth="true"
                      TextArea="true"
                      InputStyle="height: 200px; resize: none" />

        <ValidationMessage For="@(() => _torrentCreate.Content)" />
    </FormControl>

    <FormControl Class="Form-Cotrol">
        <MatNumericUpDownField Label="Size"
                               @bind-Value="@_torrentCreate.Size"
                               FullWidth="true" />

        <ValidationMessage For="@(() => _torrentCreate.Size)" />
    </FormControl>

    <FormControl Class="Form-Cotrol">
        <MatTextField @bind-Value="@_torrentCreate.Hash"
                      Label="Hash"
                      FullWidth="true" />

        <ValidationMessage For="@(() => _torrentCreate.Hash)" />
    </FormControl>

    <FormControl Class="Form-Cotrol">
        <MatNumericUpDownField Label="Tracker Id"
                               @bind-Value="@_torrentCreate.TrackerId"
                               FullWidth="true" />

        <ValidationMessage For="@(() => _torrentCreate.TrackerId)" />
    </FormControl>

    <FormControl Class="Form-Cotrol Form-Actions">
        <MatButton Label="Create" Raised="true" Disabled="@(_torrentCreate.SubcategoryId == 0)" Type="submit" />
        <MatButton OnClick="@CancelClicked" Label="Cancel" />
    </FormControl>
</EditForm>

@code
{
    [CascadingParameter] BlazoredModalInstance Modal { get; set; }

    private readonly TorrentCreateView _torrentCreate = new TorrentCreateView();

    private IEnumerable<SubcategoryView> _subcategories;

    private bool _isCanceled;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _subcategories = (await SubcategoryService.ListAsync(null)).ToArray();
        }
        catch (Exception exception)
        {
            MatToaster.Add(exception.Message, MatToastType.Danger, "Subcategories loading");
        }
    }

    private async Task CreateClicked()
    {
        if (_isCanceled)
        {
            return;
        }

        try
        {
            var result = await TorrentService.AddAsync(_torrentCreate);

            Modal.Close(ModalResult.Ok(result));

            MatToaster.Add($"The torrent '{result.Name}' was successfully created.", MatToastType.Success, "Torrent creating");
        }
        catch (Exception exception)
        {
            MatToaster.Add(exception.Message, MatToastType.Danger, "Torrent creating");
        }
    }

    private void CancelClicked()
    {
        _isCanceled = true;

        Modal.Cancel();
    }
}