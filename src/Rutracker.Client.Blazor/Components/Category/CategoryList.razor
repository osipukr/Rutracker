@inject IModalService ModalService

<h2 class="my-3">Categories list</h2>

<MatTable Items="@Items" AllowSelection="true" class="mat-elevation-z5">
    <MatTableHeader>
        <th class="p-2 text-center">
            <MatIconButton OnClick="@CreateModalOpened" Icon="@MatIconNames.Add" title="Add new category" />
        </th>
        <th title="Category id">Id</th>
        <th title="Subcategory count">Count</th>
        <th title="Category name">Name</th>
    </MatTableHeader>
    <MatTableRow Context="category">
        <td>
            <div style="width:100px;">
                <MatIconButton OnClick="@(_ => UpdateModalOpened(category))" Icon="@MatIconNames.Edit" />
                <MatIconButton OnClick="@(_ => DeleteModalOpened(category))" Icon="@MatIconNames.Delete" />
            </div>
        </td>
        <td>@category.Id</td>
        <td>@category.SubcategoriesCount</td>
        <td>
            <a class="text-dark" href="@PageHelpers.CategoryLink(category.Id)">@category.Name</a>
        </td>
    </MatTableRow>
</MatTable>

@code
{
    [Parameter] public IEnumerable<CategoryViewModel> Items { get; set; }
    [Parameter] public EventCallback<CategoryCreateViewModel> OnCreate { get; set; }
    [Parameter] public Func<CategoryViewModel, CategoryUpdateViewModel, Task> OnUpdate { get; set; }
    [Parameter] public EventCallback<CategoryViewModel> OnDelete { get; set; }

    private CategoryViewModel Category { get; set; }

    private void CreateModalOpened()
    {
        ModalService.OnClose += CreateModalClosed;
        ModalService.Show("Create category", typeof(CategoryAddModal));
    }

    private void UpdateModalOpened(CategoryViewModel model)
    {
        var parameters = new ModalParameters();

        parameters.Add(nameof(CategoryUpdateViewModel), new CategoryUpdateViewModel
        {
            Name = model.Name
        });

        Category = model;

        ModalService.OnClose += UpdateModalClosed;
        ModalService.Show("Update category", typeof(CategoryUpdateModal), parameters);
    }

    private void DeleteModalOpened(CategoryViewModel model)
    {
        var parameters = new ModalParameters();

        parameters.Add(nameof(CategoryViewModel), model);

        ModalService.OnClose += DeleteModalClosed;
        ModalService.Show("Delete category", typeof(CategoryDeleteModal), parameters);
    }

    private async void CreateModalClosed(ModalResult result)
    {
        if (!result.Cancelled && result.Data is CategoryCreateViewModel model)
        {
            await OnCreate.InvokeAsync(model);
        }

        ModalService.OnClose -= CreateModalClosed;
    }

    private async void UpdateModalClosed(ModalResult result)
    {
        if (!result.Cancelled && result.Data is CategoryUpdateViewModel model)
        {
            await OnUpdate.Invoke(Category, model);
        }

        ModalService.OnClose -= UpdateModalClosed;
    }

    private async void DeleteModalClosed(ModalResult result)
    {
        if (!result.Cancelled && result.Data is CategoryViewModel model)
        {
            await OnDelete.InvokeAsync(model);
        }

        ModalService.OnClose -= DeleteModalClosed;
    }
}
