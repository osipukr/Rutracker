@inject ICategoryService CategoryService
@inject ISubcategoryService SubcategoryService
@inject IMatToaster MatToaster

<div class="mat-layout-grid px-0">
    <div class="mat-layout-grid-inner">
        <div class="mat-layout-grid-cell mat-layout-grid-cell-span-12">
            <EditForm Model="@Filter" OnValidSubmit="@OnValidSubmitClicked">
                <DataAnnotationsValidator />

                <MatTextField @bind-Value="@Filter.Search"
                              Label="Search"
                              Icon="@MatIconNames.Search"
                              IconTrailing="true"
                              FullWidth="true"
                              InputClass="pr-5"
                              type="search" />

                <ValidationMessage For="@(() => Filter.Search)" />

                <div class="row px-0 pt-5 pb-3">
                    <div class="col">
                        <MatSelect @bind-Value="@CategoryId"
                                   Label="Category"
                                   Disabled="@(Categories == null)"
                                   Outlined="true"
                                   class="w-100">
                            <MatOption Value="">No select</MatOption>

                            @if (Categories != null)
                            {
                                @foreach (var category in Categories)
                                {
                                    <MatOption Value="@category.Id.ToString()">@category.Name</MatOption>
                                }
                            }
                        </MatSelect>
                    </div>

                    <div class="col">
                        <MatSelect @bind-Value="@SubcategoryId"
                                   Label="Subcategory"
                                   Disabled="@(Subcategories == null)"
                                   Outlined="true"
                                   class="w-100">
                            <MatOption Value="">No select</MatOption>

                            @if (Subcategories != null)
                            {
                                @foreach (var subcategory in Subcategories)
                                {
                                    <MatOption Value="@subcategory.Id.ToString()">
                                        @subcategory.Name (@subcategory.TorrentsCount)
                                    </MatOption>
                                }
                            }
                        </MatSelect>
                    </div>
                </div>

                <div class="d-flex justify-content-end">
                    <div class="d-flex justify-content-between filter-group-btn">
                        <MatButton OnClick="@ResetButtonClicked"
                                   Label="All"
                                   Disabled="@SearchInProgress"
                                   Outlined="true"
                                   class="filter-btn mat-elevation-z5"
                                   type="reset" />

                        <MatButton Label="Apply"
                                   Disabled="@SearchInProgress"
                                   TrailingIcon="@MatIconNames.Search"
                                   Raised="true"
                                   class="filter-btn mat-elevation-z5"
                                   type="submit" />
                    </div>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code
{
    [Parameter] public EventCallback<FilterViewModel> FilterChanged { get; set; }
    [Parameter] public bool SearchInProgress { get; set; }

    private FilterViewModel Filter { get; set; } = new FilterViewModel();
    private IEnumerable<CategoryViewModel> Categories { get; set; }
    private IEnumerable<SubcategoryViewModel> Subcategories { get; set; }

    private string CategoryId
    {
        get => Filter.CategoryId.ToString();
        set
        {
            if (int.TryParse(value, out var id))
            {
                Filter.CategoryId = id;
                LoadSubcategoriesAsync(id);
            }
            else
            {
                Filter.CategoryId = null;
                Subcategories = null;
            }

            SubcategoryId = null;
            StateHasChanged();
        }
    }

    private string SubcategoryId
    {
        get => Filter.SubcategoryId.ToString();
        set => Filter.SubcategoryId = int.TryParse(value, out var id) ? (int?)id : null;
    }

    protected override async Task OnInitializedAsync() => await LoadCategoriesAsync();

    private async Task LoadCategoriesAsync()
    {
        try
        {
            Categories = await CategoryService.ListAsync();
        }
        catch (Exception ex)
        {
            MatToaster.Add(ex.Message, MatToastType.Warning);
        }
    }

    private async void LoadSubcategoriesAsync(int categoryId)
    {
        try
        {
            Subcategories = await SubcategoryService.ListAsync(categoryId);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            MatToaster.Add(ex.Message, MatToastType.Warning);
        }
    }

    private void ResetFiltration()
    {
        Filter.Search = null;
        CategoryId = null;
        SubcategoryId = null;
    }

    private void ResetButtonClicked()
    {
        ResetFiltration();
        OnValidSubmitClicked();
    }

    private void OnValidSubmitClicked() => FilterChanged.InvokeAsync(Filter);
}