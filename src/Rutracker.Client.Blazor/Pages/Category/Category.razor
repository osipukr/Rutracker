@attribute [Authorize(Roles = UserRoles.Admin)]

@inject ICategoryService CategoryService
@inject ISubcategoryService SubcategoryService

@page "/categories/{id:int}"

<div class="mat-layout-grid px-0 pb-5">
    <div class="mat-layout-grid-inner">
        <div class="mat-layout-grid-cell">
            <MatIconButton Link="@Constants.Path.Categories" Icon="@MatIconNames.Arrow_back" />
        </div>
    </div>
</div>

<Page Title="category" Action="@LoadResult" Errors="@Errors">
    <h2>@CategoryModel.Name</h2>

    <SubcategoryList Items="@Subcategories"
                     OnCreate="@CreateSubcategoryAsync"
                     OnUpdate="@UpdateSubcategoryAsync"
                     OnDelete="@DeleteSubcategoryAsync" />
</Page>

@code
{
    [Parameter] public int Id { get; set; }

    private CategoryViewModel CategoryModel { get; set; }
    private List<SubcategoryViewModel> Subcategories { get; set; } = new List<SubcategoryViewModel>();

    protected override async Task OnInitializedAsync() => await LoadAsync(CategoryAsync);

    private async Task CategoryAsync()
    {
        CategoryModel = await CategoryService.FindAsync(Id);
        Subcategories = (await SubcategoryService.ListAsync(Id))?.ToList();
    }

    private async Task CreateSubcategoryAsync(SubcategoryCreateViewModel model) => await ActionAsync(async () =>
    {
        model.CategoryId = Id;

        var subcategory = await SubcategoryService.CreateAsync(model);

        Subcategories.Add(subcategory);
    }, successMessage: "Subcategory successfully created.");

    private async Task UpdateSubcategoryAsync(SubcategoryViewModel subcategory, SubcategoryUpdateViewModel model) => await ActionAsync(async () =>
    {
        if (subcategory.Name == model.Name) return;

        var result = await SubcategoryService.UpdateAsync(subcategory.Id, model);
        var index = Subcategories.FindIndex(x => x.Id == subcategory.Id);

        Subcategories[index] = result;
    }, successMessage: "Subcategory successfully updated.");

    private async Task DeleteSubcategoryAsync(SubcategoryViewModel model) => await ActionAsync(async () =>
    {
        await SubcategoryService.DeleteAsync(model.Id);

        Subcategories.Remove(model);
    }, successMessage: "Subcategory successfully deleted.");
}