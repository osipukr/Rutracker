@attribute [Authorize(Roles = UserRoles.User)]

@inject IUserService UserService

@page "/account/profile"

<Page Title="user information" Action="@ActionResult" Errors="@Errors">
    <div class="profile-container">
        <div class="profile-header">
            <div class="profile-header__image">
                <UserImage Url="@UserModel.ImageUrl" OnChange="@ChangeImageAsync" />
            </div>

            <h1 class="profile-header__name">@UserModel.UserName</h1>

            @if (UserModel.Roles != null)
            {
                <MatChipSet>
                    @foreach (var role in UserModel.Roles)
                    {
                        <MatChip Label="@role" />
                    }
                </MatChipSet>
            }
        </div>

        <div class="profile-body">
            <MatTabGroup>
                <UserInfoTab UserModel="@UserModel" OnChange="@ChangeUserAsync" />
                <PasswordTab OnChange="@ChangePasswordAsync" />
                <EmailTab UserModel="@UserModel" OnChange="@ChangeEmailAsync" />
                <PhoneTab UserModel="@UserModel" OnChange="@ChangePhoneAsync" OnConfirm="@ConfirmPhoneAsync" />
            </MatTabGroup>
        </div>
    </div>
</Page>

@code
{
    private UserDetailsViewModel UserModel { get; set; }

    protected override async Task OnInitializedAsync() => await UserAsync();

    private async Task UserAsync() => await LoadAsync(async () => UserModel = await UserService.FindAsync());

    private async Task ChangeImageAsync(ChangeImageViewModel model) => await ActionAsync(async () =>
    {
        UserModel = await UserService.ChangeImageAsync(model);

        MatToaster.Add("Image successfully changed.", MatToastType.Success);
    });

    private async Task ChangeUserAsync(ChangeUserViewModel model) => await ActionAsync(async () =>
    {
        UserModel = await UserService.ChangeInfoAsync(model);

        MatToaster.Add("User successfully changed.", MatToastType.Success);
    });

    private async Task ChangeEmailAsync(ChangeEmailViewModel model) => await ActionAsync(async () =>
    {
        await UserService.ChangeEmailAsync(model);

        MatToaster.Add("Please check your email to confirm your changes.", MatToastType.Success);
    });

    private async Task ChangePasswordAsync(ChangePasswordViewModel model) => await ActionAsync(async () =>
    {
        await UserService.ChangePasswordAsync(model);

        MatToaster.Add("Password successfully changed.", MatToastType.Success);
    });

    private async Task ChangePhoneAsync(ChangePhoneNumberViewModel model) => await ActionAsync(async () =>
    {
        await UserService.ChangePhoneAsync(model);

        MatToaster.Add("Verification code sent to phone number.", MatToastType.Success);
    });

    private async Task ConfirmPhoneAsync(ConfirmChangePhoneNumberViewModel model) => await ActionAsync(async () =>
    {
        UserModel = await UserService.ConfirmChangePhoneAsync(model);

        MatToaster.Add("Change phone successfully confirmed.", MatToastType.Success);
    });
}