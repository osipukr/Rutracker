@inject AppState AppState
@inject ViewSettings ViewSettings
@inject IMatToaster MatToaster

@page "/torrents"

@if (TorrentsModel != null)
{
    <Filtration Model="@FilterModel" FilterChanged="@FilterChanged" />

    <TorrentList Items="@TorrentsModel.Items" />

    <Pagination Page="@TorrentsModel.Page"
                PageSize="@TorrentsModel.PageSize"
                TotalPages="@TorrentsModel.TotalPages"
                PageChanged="@PageChanged" />
}
else if (AppState.SearchInProgress)
{
    <LoadingBackground>
        <span>Loading page model, please wait...</span>
    </LoadingBackground>
}
else
{
    <LoadingBackground ShowLoader="false">
        <p>Failed to load page model</p>
        <MatButton OnClick="@ReloadClicked" Raised="true" Label="Try again" />
    </LoadingBackground>
}

@code
{
    private PaginationResult<TorrentViewModel> TorrentsModel { get; set; }
    private FilterViewModel FilterModel { get; set; } = new FilterViewModel();

    private int Page { get; set; } = 1;
    private int PageSize => ViewSettings.TorrentsPerPageCount;

    protected override async Task OnInitAsync() => await LoadTorrentsIndexAsync(Page, FilterModel);

    private async Task LoadTorrentsIndexAsync(int page, FilterViewModel filter)
    {
        try
        {
            TorrentsModel = await AppState.Torrents(page, PageSize, filter);
        }
        catch (Exception ex)
        {
            MatToaster.Add(ex.Message, MatToastType.Warning, "Failed load torrent list");
        }
    }

    private async Task ReloadClicked() => await LoadTorrentsIndexAsync(Page, FilterModel);

    private async Task PageChanged(int page) => await LoadTorrentsIndexAsync(Page = page, FilterModel);

    private async Task FilterChanged() => await PageChanged(1);
}